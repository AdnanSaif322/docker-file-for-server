# -----------------------------
# Base image
# -----------------------------
FROM debian:bookworm-slim

# -----------------------------
# Environment variables
# -----------------------------
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8
ENV PATH=$PATH:/usr/local/go/bin:/root/go/bin

# -----------------------------
# Install system dependencies
# -----------------------------
RUN apt-get update && apt-get install -y \
    curl git wget unzip tar build-essential cmake g++ pkg-config \
    libtool libtool-bin autoconf automake ninja-build gettext \
    libjson-c-dev libwebsockets-dev \
    ca-certificates \
    sqlite3 httpie \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------
# Install Go (ARM64)
# -----------------------------
ARG GO_VERSION=1.22.6
RUN wget https://go.dev/dl/go${GO_VERSION}.linux-arm64.tar.gz && \
    tar -C /usr/local -xzf go${GO_VERSION}.linux-arm64.tar.gz && \
    rm go${GO_VERSION}.linux-arm64.tar.gz

# -----------------------------
# Install Neovim (latest stable)
# -----------------------------
RUN git clone https://github.com/neovim/neovim.git /tmp/neovim && \
    cd /tmp/neovim && \
    git checkout stable && \
    make CMAKE_BUILD_TYPE=Release && \
    make install && \
    rm -rf /tmp/neovim

# -----------------------------
# Install LazyVim starter config
# -----------------------------
RUN git clone https://github.com/LazyVim/starter /root/.config/nvim && \
    rm -rf /root/.config/nvim/.git

# -----------------------------
# Install ttyd from source
# -----------------------------
RUN git clone https://github.com/tsl0922/ttyd.git /tmp/ttyd && \
    cd /tmp/ttyd && \
    mkdir build && cd build && \
    cmake .. && \
    make && make install && \
    rm -rf /tmp/ttyd

# -----------------------------
# Install Boot.dev CLI
# -----------------------------
RUN go install github.com/bootdotdev/bootdev@latest

# -----------------------------
# Set working directory
# -----------------------------
WORKDIR /workspace

# -----------------------------
# Default command: ttyd with password and writable mode
# -----------------------------
CMD ["ttyd", "-p", "7681", "-c", "saif:104209", "--writable", "bash"]

